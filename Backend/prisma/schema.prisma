generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
}

// สิทธิ์แอดมิน
enum AdminRole {
  SUPER_ADMIN
  STAFF
}

// สถานะห้อง
enum RoomStatus {
  AVAILABLE // ว่าง
  OCCUPIED // ไม่ว่าง
}

// สถานะการอนุมัติการจอง
enum BookingApproveStatus {
  PENDING
  APPROVED
  REJECTED
}

// สถานะการเช็คอิน
enum CheckinStatus {
  NOT_CHECKED_IN
  CHECKED_IN
  FAILED
}

// สถานะการคืนห้อง
enum CheckoutStatus {
  PENDING // รออนุมัติคืน
  APPROVED // อนุมัติแล้ว (รอมาเช็คเอาท์)
  COMPLETED // เช็คเอาท์แล้ว
  REJECTED // ปฏิเสธ
}

// สถานะบิล
enum BillStatus {
  UNPAID
  PAID
  VERIFYING
}

// Admin
model Admin {
  adminId  String    @id @default(auto()) @map("_id") @db.ObjectId
  username String    @unique
  name     String
  password String
  role     AdminRole @default(STAFF)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roomsCreated Room[] @relation("RoomCreatedBy")
  roomsUpdated Room[] @relation("RoomUpdatedBy")
  billsCreated Bill[] @relation("BillCreatedBy")
  billsUpdated Bill[] @relation("BillUpdatedBy")
}

//Room
model Room {
  roomId     String @id @default(auto()) @map("_id") @db.ObjectId
  number     String @unique
  size       String
  rent       Int
  deposit    Int
  bookingFee Int

  status RoomStatus @default(AVAILABLE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy String  @db.ObjectId
  updatedBy String? @db.ObjectId

  adminCreated Admin? @relation("RoomCreatedBy", fields: [createdBy], references: [adminId])
  adminUpdated Admin? @relation("RoomUpdatedBy", fields: [updatedBy], references: [adminId])

  bookings  Booking[]
  bills     Bill[]
  checkouts Checkout[]
}

//Customer
model Customer {
  customerId String @id @default(auto()) @map("_id") @db.ObjectId
  userId     String
  userName   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings  Booking[]
  bills     Bill[]
  payments  Payment[]
  checkouts Checkout[]
}

// Booking (การเข้าพัก)
model Booking {
  bookingId  String @id @default(auto()) @map("_id") @db.ObjectId
  roomId     String @db.ObjectId
  customerId String @db.ObjectId

  // snapshot ลูกค้า
  ctitle   String?
  cname    String?
  csurname String?
  fullName String?
  cphone   String?
  cmumId   String?

  checkin       DateTime
  actualCheckin DateTime?

  approveStatus BookingApproveStatus @default(PENDING)
  checkinStatus CheckinStatus        @default(NOT_CHECKED_IN)

  slipUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room     Room     @relation(fields: [roomId], references: [roomId])
  customer Customer @relation(fields: [customerId], references: [customerId])

  checkout Checkout?
  bills    Bill[]
}

//Checkout (การคืนห้อง)
model Checkout {
  checkoutId String @id @default(auto()) @map("_id") @db.ObjectId

  bookingId  String @unique @db.ObjectId
  roomId     String @db.ObjectId
  customerId String @db.ObjectId

  requestedCheckout DateTime
  approvedAt        DateTime?
  actualCheckout    DateTime?

  status CheckoutStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [bookingId])
  room     Room     @relation(fields: [roomId], references: [roomId])
  customer Customer @relation(fields: [customerId], references: [customerId])
}

//Bill
model Bill {
  billId String   @id @default(auto()) @map("_id") @db.ObjectId
  month  DateTime

  rent         Int
  service      Int @default(50)
  wBefore      Int
  wAfter       Int
  wUnits       Int
  wPrice       Int @default(19)
  waterCost    Int @default(0)
  eBefore      Int
  eAfter       Int
  eUnits       Int
  ePrice       Int @default(7)
  electricCost Int @default(0)
  fine         Int @default(0)
  overdueDays  Int @default(0)
  total        Int @default(0)

  status  BillStatus @default(UNPAID)
  dueDate DateTime

  ctitle   String?
  cname    String?
  csurname String?
  fullName String?
  cphone   String?
  slipUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roomId String @db.ObjectId
  room   Room   @relation(fields: [roomId], references: [roomId])

  customerId String?   @db.ObjectId
  customer   Customer? @relation(fields: [customerId], references: [customerId])

  bookingId String?  @db.ObjectId
  booking   Booking? @relation(fields: [bookingId], references: [bookingId])

  createdBy    String  @db.ObjectId
  updatedBy    String? @db.ObjectId
  adminCreated Admin?  @relation("BillCreatedBy", fields: [createdBy], references: [adminId])
  adminUpdated Admin?  @relation("BillUpdatedBy", fields: [updatedBy], references: [adminId])

  payment Payment?
}

// Payment
model Payment {
  paymentId  String  @id @default(auto()) @map("_id") @db.ObjectId
  billId     String  @unique @db.ObjectId
  customerId String  @db.ObjectId
  slipUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bill     Bill     @relation(fields: [billId], references: [billId])
  customer Customer @relation(fields: [customerId], references: [customerId])
}
