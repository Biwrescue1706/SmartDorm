// Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//===Admin ===
model Admin {
  adminId  String @id @default(auto()) @map("_id") @db.ObjectId
  username String @unique // ชื่อผู้ใช้
  name     String // ชื่อ
  password String // รหัสผ่าน
  role     Int    @default(1) // 0 = แอดมิน , 1 = พนักงาน

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roomsCreated Room[] @relation("RoomCreatedBy")
  roomsUpdated Room[] @relation("RoomUpdatedBy")
  billsCreated Bill[] @relation("BillCreatedBy")
  billsUpdated Bill[] @relation("BillUpdatedBy")
}

//=== Room ===
model Room {
  roomId     String @id @default(auto()) @map("_id") @db.ObjectId
  number     String @unique // หมายเลขห้อง
  size       String // ขนาดห้อง
  rent       Int // ค่าเช่าห้อง
  deposit    Int // ค่าประกันห้อง
  bookingFee Int // ค่าธรรมเนียมการจอง

  status Int @default(0) // 0 = ว่าง , 1 = ถูกจองแล้ว

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy String  @db.ObjectId
  updatedBy String? @db.ObjectId

  adminCreated Admin? @relation("RoomCreatedBy", fields: [createdBy], references: [adminId])
  adminUpdated Admin? @relation("RoomUpdatedBy", fields: [updatedBy], references: [adminId])

  bookings  Booking[]
  bills     Bill[]
  checkouts Checkout[]
}

//=== Customer ===
model Customer {
  customerId String @id @default(auto()) @map("_id") @db.ObjectId
  userId     String
  userName   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings  Booking[]
  bills     Bill[]
  payments  Payment[]
  checkouts Checkout[]
}

//=== Booking ===
model Booking {
  bookingId  String  @id @default(auto()) @map("_id") @db.ObjectId
  roomId     String  @db.ObjectId // ห้องที่จอง
  customerId String  @db.ObjectId // ลูกค้าที่จอง
  ctitle     String? // คำนำหน้า
  cname      String? // ชื่อ
  csurname   String? // นามสกุล
  fullName   String? // ชื่อ-นามสกุล
  cphone     String? // เบอร์โทร
  cmumId     String? // หมายเลขบัตรประชาชน

  bookingDate DateTime @default(now()) // วันที่จอง

  //check-in
  checkin       DateTime // วันที่ต้องการเช็คอิน
  checkinAt     DateTime? // วันที่เช็คอินจริง
  checkinStatus Int       @default(0) // 0 = ยังไม่เช็คอิน ,1 = เช็คอินแล้ว

  //approval
  approveStatus Int       @default(0) //0 = รอการอนุมัติ , 1 = อนุมัติ , 2 = ปฏิเสธ
  approvedAt    DateTime? // วันที่อนุมัติ

  slipUrl String? // รูปสลิปการโอนเงิน

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room     Room     @relation(fields: [roomId], references: [roomId])
  customer Customer @relation(fields: [customerId], references: [customerId])

  checkout Checkout[]
  bills    Bill[]

  @@index([roomId])
  @@index([customerId])
  @@index([approveStatus])
}

//=== Checkout ===
model Checkout {
  checkoutId String @id @default(auto()) @map("_id") @db.ObjectId

  bookingId  String @db.ObjectId
  roomId     String @db.ObjectId
  customerId String @db.ObjectId

  // ขอคืน
  checkout             DateTime // วันที่ขอคืน
  ReturnApprovalStatus Int       @default(0) //0 = รอการอนุมัติ , 1 = อนุมัติ , 2 = ปฏิเสธ
  RefundApprovalDate   DateTime? //วันที่อนุมัติคืน

  // คืนจริง
  checkoutStatus Int       @default(0) //0 = กำลังรอ , 1 = เช็คเอาท์แล้ว
  checkoutAt     DateTime? //วันที่คืนจริง

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [bookingId])
  room     Room     @relation(fields: [roomId], references: [roomId])
  customer Customer @relation(fields: [customerId], references: [customerId])

  @@index([bookingId])
  @@index([checkoutStatus])
  @@index([ReturnApprovalStatus])
}

//=== Bill ===
model Bill {
  billId     String  @id @default(auto()) @map("_id") @db.ObjectId
  roomId     String? @db.ObjectId
  customerId String? @db.ObjectId
  bookingId  String? @db.ObjectId

  month DateTime

  ctitle   String?
  cname    String?
  csurname String?
  fullName String?
  cphone   String?

  total Int @default(0) // ยอดรวมที่ต้องชำระ

  billStatus Int       @default(0) // 0 = ยังไม่ชำระเงิน, 1 = ชำระเงินแล้ว, 2 = กำลังตรวจสอบ
  billDate   DateTime? // วันที่สถานะบิลเปลี่ยนแปลง

  paidAt DateTime? // วันที่ชำระเงิน

  dueDate DateTime // วันครบกำหนดชำระเงิน
  slipUrl String?

  rent         Int // ค่าเช่าห้อง
  service      Int @default(50) // ค่าส่วนกลาง
  //ค่าน้ำ
  wBefore      Int // ค่าน้ำหน่วยก่อนหน้า
  wAfter       Int // ค่าน้ำหน่วยปัจจุบัน
  wUnits       Int // ค่าน้ำที่ใช้
  waterCost    Int @default(0) // ค่าน้ำที่ต้องจ่าย
  //ค่าไฟ
  eBefore      Int // ค่าไฟหน่วยก่อนหน้า
  eAfter       Int // ค่าไฟหน่วยปัจจุบัน
  eUnits       Int // ค่าไฟที่ใช้
  electricCost Int @default(0) // ค่าไฟที่ต้องจ่าย

  // ค่าปรับ
  fine        Int @default(0) // ค่าปรับ
  overdueDays Int @default(0) // จำนวนวันที่ค้างชำระ

  lastOverdueNotifyAt DateTime?

  createdAt DateTime @default(now())
  createdBy String   @db.ObjectId
  updatedAt DateTime @updatedAt
  updatedBy String?  @db.ObjectId

  room         Room?     @relation(fields: [roomId], references: [roomId])
  customer     Customer? @relation(fields: [customerId], references: [customerId])
  booking      Booking?  @relation(fields: [bookingId], references: [bookingId])
  adminCreated Admin?    @relation("BillCreatedBy", fields: [createdBy], references: [adminId])
  adminUpdated Admin?    @relation("BillUpdatedBy", fields: [updatedBy], references: [adminId])

  payment Payment?

  @@index([roomId])
  @@index([customerId])
  @@index([billStatus])
}

//=== Payment ===
model Payment {
  paymentId  String @id @default(auto()) @map("_id") @db.ObjectId
  billId     String @unique @db.ObjectId
  customerId String @db.ObjectId

  paidAt  DateTime? // วันที่ชำระเงิน
  slipUrl String? // รูปสลิปการโอนเงิน

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bill     Bill     @relation(fields: [billId], references: [billId])
  customer Customer @relation(fields: [customerId], references: [customerId])
}
