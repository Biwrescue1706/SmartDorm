generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//Admin

model Admin {
  adminId  String @id @default(auto()) @map("_id") @db.ObjectId
  username String @unique
  name     String
  password String
  role     Int    @default(1) // 0 = SUPER_ADMIN, 1 = STAFF

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roomsCreated Room[] @relation("RoomCreatedBy")
  roomsUpdated Room[] @relation("RoomUpdatedBy")
  billsCreated Bill[] @relation("BillCreatedBy")
  billsUpdated Bill[] @relation("BillUpdatedBy")
}

//Room
model Room {
  roomId     String @id @default(auto()) @map("_id") @db.ObjectId
  number     String @unique
  size       String
  rent       Int
  deposit    Int
  bookingFee Int

  status Int @default(0) // 0 = AVAILABLE, 1 = OCCUPIED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy String  @db.ObjectId
  updatedBy String? @db.ObjectId

  adminCreated Admin? @relation("RoomCreatedBy", fields: [createdBy], references: [adminId])
  adminUpdated Admin? @relation("RoomUpdatedBy", fields: [updatedBy], references: [adminId])

  bookings  Booking[]
  bills     Bill[]
  checkouts Checkout[]
}

//Customer
model Customer {
  customerId String @id @default(auto()) @map("_id") @db.ObjectId
  userId     String
  userName   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings  Booking[]
  bills     Bill[]
  payments  Payment[]
  checkouts Checkout[]
}

//Booking
model Booking {
  bookingId  String @id @default(auto()) @map("_id") @db.ObjectId
  roomId     String @db.ObjectId
  customerId String @db.ObjectId

  ctitle   String?
  cname    String?
  csurname String?
  fullName String?
  cphone   String?
  cmumId   String?

  checkin       DateTime
  actualCheckin DateTime?

  approveStatus Int @default(0) // 0=PENDING,1=APPROVED,2=REJECTED
  checkinStatus Int @default(0) // 0=NOT_CHECKED_IN,1=CHECKED_IN,2=FAILED

  slipUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room     Room     @relation(fields: [roomId], references: [roomId])
  customer Customer @relation(fields: [customerId], references: [customerId])

  checkout Checkout?
  bills    Bill[]
}

//Checkout
model Checkout {
  checkoutId String @id @default(auto()) @map("_id") @db.ObjectId

  bookingId  String @db.ObjectId
  roomId     String @db.ObjectId
  customerId String @db.ObjectId

  requestedCheckout DateTime // วันขอคืน

  status     Int      @default(0) 
  // 0 = PENDING
  // 1 = APPROVED
  // 2 = REJECTED

  approvedAt DateTime?

  checkoutStatus Int      @default(0)
  // 0 = Waiting for checkout
  // 1 = Checked out

  actualCheckout DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [bookingId])
  room     Room     @relation(fields: [roomId], references: [roomId])
  customer Customer @relation(fields: [customerId], references: [customerId])

  @@index([bookingId])
  @@index([status])
}

//Bill
model Bill {
  billId String   @id @default(auto()) @map("_id") @db.ObjectId
  month  DateTime

  rent         Int
  service      Int @default(50)
  wBefore      Int
  wAfter       Int
  wUnits       Int
  wPrice       Int @default(19)
  waterCost    Int @default(0)
  eBefore      Int
  eAfter       Int
  eUnits       Int
  ePrice       Int @default(7)
  electricCost Int @default(0)
  fine         Int @default(0)
  overdueDays  Int @default(0)
  total        Int @default(0)

  status  Int      @default(0) // 0=UNPAID,1=PAID,2=VERIFYING
  dueDate DateTime

  ctitle   String?
  cname    String?
  csurname String?
  fullName String?
  cphone   String?
  slipUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roomId String @db.ObjectId
  room   Room   @relation(fields: [roomId], references: [roomId])

  customerId String?   @db.ObjectId
  customer   Customer? @relation(fields: [customerId], references: [customerId])

  bookingId String?  @db.ObjectId
  booking   Booking? @relation(fields: [bookingId], references: [bookingId])

  createdBy    String  @db.ObjectId
  updatedBy    String? @db.ObjectId
  adminCreated Admin?  @relation("BillCreatedBy", fields: [createdBy], references: [adminId])
  adminUpdated Admin?  @relation("BillUpdatedBy", fields: [updatedBy], references: [adminId])

  payment Payment?
}

// Payment
model Payment {
  paymentId  String  @id @default(auto()) @map("_id") @db.ObjectId
  billId     String  @unique @db.ObjectId
  customerId String  @db.ObjectId
  slipUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bill     Bill     @relation(fields: [billId], references: [billId])
  customer Customer @relation(fields: [customerId], references: [customerId])
}
