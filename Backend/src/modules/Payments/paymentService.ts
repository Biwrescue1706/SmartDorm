// src/modules/Payments/paymentService.ts
import { paymentRepository } from "./paymentRepository";
import { verifyLineToken } from "../../utils/verifyLineToken";
import { PaymentInput } from "./paymentModel";
import { sendFlexMessage } from "../../utils/lineFlex";

// üóìÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
const formatThaiDate = (dateInput: string | Date) => {
  const date = typeof dateInput === "string" ? new Date(dateInput) : dateInput;
  return date.toLocaleDateString("th-TH", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

export const paymentService = {
  // üí∏ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
  async createPayment(input: PaymentInput) {
    const { billId, accessToken, slip } = input;

    if (!accessToken) throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ accessToken ‡∏à‡∏≤‡∏Å LINE LIFF");
    if (!slip) throw new Error("‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞");

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏à‡∏≤‡∏Å LINE ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á userId + displayName
    const { userId } = await verifyLineToken(accessToken);

    // üë§ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    const customer = await paymentRepository.findCustomerByUserId(userId);
    if (!customer) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");

    // üßæ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏¥‡∏•
    const bill = await paymentRepository.findBillById(billId);
    if (!bill) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•");
    if (bill.customerId !== customer.customerId)
      throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ");
    if (bill.status === 1) throw new Error("‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß");

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô bill ‡∏à‡∏£‡∏¥‡∏á
    if (!bill.customer) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ");
    }

    // üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏õ Supabase
    const slipUrl = await paymentRepository.uploadSlipToSupabase(slip);

    // üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const [payment, updatedBill] =
      await paymentRepository.createPaymentAndUpdateBill(
        billId,
        slipUrl,
        bill.customerId
      );

    const customerDetailUrl = `https://smartdorm-paymentbill.biwbong.shop`;
    const adminUrl = `https://smartdorm-admin.biwbong.shop`;
    
    // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢ Flex Message
    await sendFlexMessage(
      bill.customer.userId,
      "üí∞ ‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",
      [
        { label: "‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏¥‡∏•", value: bill.billId },
        { label: "‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞", value: payment.paymentId },
        { label: "üè† ‡∏´‡πâ‡∏≠‡∏á", value: bill.room?.number ?? "-" },
        { label: "‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞", value: `${bill.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó` },
        { label: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", value: formatThaiDate(payment.createdAt) },
        {
          label: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
          value: "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
          color: "#f39c12",
        },
      ],
      "üîó ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
      customerDetailUrl
    );

    /* ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Flex Message */
    if (process.env.ADMIN_LINE_ID) {
      await sendFlexMessage(
        process.env.ADMIN_LINE_ID,
        "üì¢ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤",
        [
          { label: "‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏¥‡∏•", value: bill.billId },
          { label: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤", value: bill.customer.fullName },
          { label: "üè† ‡∏´‡πâ‡∏≠‡∏á", value: bill.room?.number ?? "-" },
          { label: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", value: bill.customer.cphone },
          { label: "‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞", value: `${bill.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó` },
          { label: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞", value: formatThaiDate(payment.createdAt) },
          {
            label :"‡∏™‡∏•‡∏¥‡∏õ" ,value : bill.slipUrl || "‡πÑ‡∏°‡πà‡∏°‡∏µ"
          },
        ],
        "üîó ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Admin",
        adminUrl
      );
    }

    return { payment, bill: updatedBill };
  },
};
